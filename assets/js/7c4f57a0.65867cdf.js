"use strict";(self.webpackChunkocelot_website=self.webpackChunkocelot_website||[]).push([[9884],{3341:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>o,contentTitle:()=>a,default:()=>h,frontMatter:()=>c,metadata:()=>n,toc:()=>l});const n=JSON.parse('{"id":"docu/how-to/unit_test","title":"Add Unit Test","description":"How to create new unit test","source":"@site/docs/docu/how-to/unit_test.md","sourceDirName":"docu/how-to","slug":"/docu/how-to/unit_test","permalink":"/docs/docu/how-to/unit_test","draft":false,"unlisted":false,"editUrl":"https://github.com/ocelot-collab/ocelot-collab.github.io/tree/main/docs/docu/how-to/unit_test.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2,"title":"Add Unit Test","description":"How to create new unit test"},"sidebar":"docsSidebar","previous":{"title":"Create Pull Request","permalink":"/docs/docu/how-to/pull_request"},"next":{"title":"Create Your Own Physics Process","permalink":"/docs/docu/how-to/phys_proc"}}');var i=s(4848),r=s(8453);const c={sidebar_position:2,title:"Add Unit Test",description:"How to create new unit test"},a="How to Add a Unit Test",o={},l=[{value:"1. Where to Put Your Tests",id:"1-where-to-put-your-tests",level:2},{value:"2. Writing Simple Unit Tests",id:"2-writing-simple-unit-tests",level:2},{value:"3. Writing Complex and Specialized Tests",id:"3-writing-complex-and-specialized-tests",level:2},{value:"Fixtures in <code>*_conf.py</code>",id:"fixtures-in-_confpy",level:3},{value:"Tests with Matching and Twiss Parameters",id:"tests-with-matching-and-twiss-parameters",level:3},{value:"Tests with Collective Effects (CSR, etc.)",id:"tests-with-collective-effects-csr-etc",level:3},{value:"Parametrized Tests",id:"parametrized-tests",level:3},{value:"Auto-updating Reference Results",id:"auto-updating-reference-results",level:3},{value:"Logging and Timing",id:"logging-and-timing",level:3},{value:"4. Running Tests",id:"4-running-tests",level:2},{value:"5. Tips",id:"5-tips",level:2}];function d(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"how-to-add-a-unit-test",children:"How to Add a Unit Test"})}),"\n",(0,i.jsx)(t.p,{children:"Writing unit tests is essential to maintain code quality and ensure your contributions work as expected. This guide shows how to write both simple and more complex tests in the Ocelot project."}),"\n",(0,i.jsx)(t.h2,{id:"1-where-to-put-your-tests",children:"1. Where to Put Your Tests"}),"\n",(0,i.jsxs)(t.p,{children:["All unit tests are located in the ",(0,i.jsx)(t.a,{href:"https://github.com/ocelot-collab/ocelot/tree/master/unit_tests",children:(0,i.jsx)(t.code,{children:"unit_tests/"})})," directory. Organize your tests in a folder that matches the module or functionality you're testing."]}),"\n",(0,i.jsx)(t.p,{children:"For example:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:"unit_tests/\n  ebeam_test/\n    matching/\n      match_test.py\n      match_conf.py\n    csr_ex/\n      csr_ex_test.py\n      csr_ex_conf.py\n      ref_results/\n"})}),"\n",(0,i.jsx)(t.h2,{id:"2-writing-simple-unit-tests",children:"2. Writing Simple Unit Tests"}),"\n",(0,i.jsx)(t.p,{children:"Here are a few simple examples to help you get started:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-python",children:"def test_Twiss_to_series(a_twiss_instance, a_twiss_dictionary):\n    twiss = a_twiss_instance\n    assert dict(twiss.to_series()) == a_twiss_dictionary\n"})}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-python",children:"def test_particle_array_total_charge():\n    parray = ParticleArray(2)\n    parray.q_array[0] = 1e-14\n    parray.q_array[1] = 5e-14\n    assert parray.total_charge == 6e-14\n"})}),"\n",(0,i.jsxs)(t.p,{children:["Examples above were taken from ",(0,i.jsx)(t.a,{href:"https://github.com/ocelot-collab/ocelot/blob/master/unit_tests/cpbd/test_beam.py",children:"here"}),".\nMore simple unit tests can be found ",(0,i.jsx)(t.a,{href:"https://github.com/ocelot-collab/ocelot/tree/master/unit_tests/cpbd",children:"here"})]}),"\n",(0,i.jsx)(t.h2,{id:"3-writing-complex-and-specialized-tests",children:"3. Writing Complex and Specialized Tests"}),"\n",(0,i.jsx)(t.p,{children:"More advanced tests in Ocelot often cover:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Accelerator lattice matching and beam optics"}),"\n",(0,i.jsx)(t.li,{children:"Particle tracking with and without collective effects"}),"\n",(0,i.jsx)(t.li,{children:"Use of reference results to ensure reproducibility"}),"\n"]}),"\n",(0,i.jsxs)(t.h3,{id:"fixtures-in-_confpy",children:["Fixtures in ",(0,i.jsx)(t.code,{children:"*_conf.py"})]}),"\n",(0,i.jsxs)(t.p,{children:["Configuration and fixtures such as lattice definitions or beam setups are placed in files like\n",(0,i.jsx)(t.a,{href:"https://github.com/ocelot-collab/ocelot/blob/master/unit_tests/ebeam_test/matching/match_conf.py",children:(0,i.jsx)(t.code,{children:"match_conf.py"})})," or\n",(0,i.jsx)(t.a,{href:"https://github.com/ocelot-collab/ocelot/blob/master/unit_tests/ebeam_test/csr_ex/csr_ex_conf.py",children:(0,i.jsx)(t.code,{children:"csr_ex_conf.py"})}),". These use ",(0,i.jsx)(t.code,{children:"pytest.fixture"})," and are imported into test scripts."]}),"\n",(0,i.jsx)(t.h3,{id:"tests-with-matching-and-twiss-parameters",children:"Tests with Matching and Twiss Parameters"}),"\n",(0,i.jsxs)(t.p,{children:["Files like ",(0,i.jsx)(t.a,{href:"https://github.com/ocelot-collab/ocelot/blob/master/unit_tests/ebeam_test/matching/match_test.py",children:(0,i.jsx)(t.code,{children:"match_test.py"})})," demonstrate tests for lattice optics and matching algorithms. They rely on:"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["Reference ",(0,i.jsx)(t.a,{href:"/docs/docu/OCELOT%20fundamentals/twiss",children:"Twiss"})," or matrix results (in ",(0,i.jsx)(t.code,{children:"ref_results/"}),")"]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.a,{href:"/docs/docu/OCELOT%20fundamentals/matching",children:"Matching functions"})," that alter element parameters to satisfy constraints"]}),"\n",(0,i.jsxs)(t.li,{children:["Optional regeneration of reference results with ",(0,i.jsx)(t.code,{children:"update_ref_values=True"})]}),"\n"]}),"\n",(0,i.jsx)(t.h3,{id:"tests-with-collective-effects-csr-etc",children:"Tests with Collective Effects (CSR, etc.)"}),"\n",(0,i.jsxs)(t.p,{children:["Files like ",(0,i.jsx)(t.a,{href:"https://github.com/ocelot-collab/ocelot/blob/master/unit_tests/ebeam_test/csr_ex/csr_ex_test.py",children:(0,i.jsx)(t.code,{children:"csr_ex_test.py"})})," demonstrate tests for collective effects such as ",(0,i.jsx)(t.a,{href:"/docs/docu/physics-processes/csr",children:(0,i.jsx)(t.strong,{children:"Coherent Synchrotron Radiation (CSR)"})}),". These tests:"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["Track ",(0,i.jsx)(t.a,{href:"/docs/docu/OCELOT%20fundamentals/particle-array",children:(0,i.jsx)(t.code,{children:"ParticleArray"})})," through lattices"]}),"\n",(0,i.jsxs)(t.li,{children:["Enable ",(0,i.jsx)(t.a,{href:"/docs/docu/physics-processes/csr",children:"CSR"})," as a physics process via ",(0,i.jsx)(t.a,{href:"/docs/docu/OCELOT%20fundamentals/navigator",children:(0,i.jsx)(t.code,{children:"Navigator"})})]}),"\n",(0,i.jsxs)(t.li,{children:["Compare final ",(0,i.jsx)(t.a,{href:"/docs/docu/OCELOT%20fundamentals/twiss",children:"Twiss"})," and particle distributions with reference outputs"]}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"Example test with CSR:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-python",children:"csr = CSR()\ncsr.energy = p_array.E\nnavi = Navigator(lattice)\nnavi.add_physics_proc(csr, lattice.sequence[0], lattice.sequence[-1])\ntws_track, p_array = track(lattice, p_array, navi)\n"})}),"\n",(0,i.jsx)(t.p,{children:"You can compare results like this:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-python",children:'p = obj2dict(p_array)\np_ref = json_read("ref_results/test_track_with_csr0.json")\nresult = check_dict(p, p_ref, tolerance=1e-8)\nassert check_result(result)\n'})}),"\n",(0,i.jsx)(t.h3,{id:"parametrized-tests",children:"Parametrized Tests"}),"\n",(0,i.jsxs)(t.p,{children:["Some tests use ",(0,i.jsx)(t.code,{children:"@pytest.mark.parametrize"})," to check several variations of the same logic. For example:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-python",children:"@pytest.mark.parametrize('parameter', [0, 1])\ndef test_track_with_and_without_tilt(lattice, parameter):\n    if parameter == 1:\n        # apply tilt to bends\n"})}),"\n",(0,i.jsx)(t.h3,{id:"auto-updating-reference-results",children:"Auto-updating Reference Results"}),"\n",(0,i.jsxs)(t.p,{children:["All advanced tests can support regenerating expected outputs by passing ",(0,i.jsx)(t.code,{children:"update_ref_values=True"}),". There's also a central function marked with ",(0,i.jsx)(t.code,{children:"@pytest.mark.update"})," to handle this:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-python",children:'@pytest.mark.update\ndef test_update_ref_values(lattice, p_array, cmdopt):\n    result = eval(cmdopt)(lattice, p_array, ..., update_ref_values=True)\n    json_save(result, f"ref_results/{cmdopt}.json")\n'})}),"\n",(0,i.jsx)(t.h3,{id:"logging-and-timing",children:"Logging and Timing"}),"\n",(0,i.jsxs)(t.p,{children:["Tests can log performance using ",(0,i.jsx)(t.code,{children:"setup_function"}),", ",(0,i.jsx)(t.code,{children:"teardown_function"}),", and global ",(0,i.jsx)(t.code,{children:"pytest"})," objects to record timings and output to logs."]}),"\n",(0,i.jsx)(t.hr,{}),"\n",(0,i.jsx)(t.h2,{id:"4-running-tests",children:"4. Running Tests"}),"\n",(0,i.jsx)(t.p,{children:"To run all tests:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"python -m pytest unit_tests\n"})}),"\n",(0,i.jsx)(t.p,{children:"To run a single test file (EXAMPLE):"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"python -m pytest unit_tests/ebeam_test/matching/match_test.py\n"})}),"\n",(0,i.jsx)(t.p,{children:"To run a single test from specific file (example for match_test.py)"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"python3 -m pytest unit_tests/ebeam_test/matching/match_test.py::TEST_FUNCTION\n"})}),"\n",(0,i.jsx)(t.p,{children:"To update reference results for one test:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"python -m pytest unit_tests/.../filename_test.py --update=TEST_FUNCTION\n"})}),"\n",(0,i.jsx)(t.p,{children:"Example for match_tes.py"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",children:"python -m pytest unit_tests/ebeam_test/matching/match_test.py --update=test_drift_match\n"})}),"\n",(0,i.jsx)(t.h2,{id:"5-tips",children:"5. Tips"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["Keep long or reusable structures in ",(0,i.jsx)(t.code,{children:"*_conf.py"})," as ",(0,i.jsx)(t.code,{children:"pytest"})," fixtures."]}),"\n",(0,i.jsxs)(t.li,{children:["Use ",(0,i.jsx)(t.code,{children:"json_save"}),", ",(0,i.jsx)(t.code,{children:"json_read"}),", ",(0,i.jsx)(t.code,{children:"obj2dict"}),", and ",(0,i.jsx)(t.code,{children:"numpy2json"})," for test data."]}),"\n",(0,i.jsxs)(t.li,{children:["Use ",(0,i.jsx)(t.code,{children:"check_value"}),", ",(0,i.jsx)(t.code,{children:"check_matrix"}),", and ",(0,i.jsx)(t.code,{children:"check_dict"})," or numpy testing function to compare results."]}),"\n",(0,i.jsxs)(t.li,{children:["Use ",(0,i.jsx)(t.code,{children:"copy.deepcopy()"})," when modifying lattice or particle arrays to avoid state corruption between tests."]}),"\n"]}),"\n",(0,i.jsx)(t.hr,{}),"\n",(0,i.jsxs)(t.p,{children:["If you\u2019re unsure how to structure a test, reach out or refer to existing tests under ",(0,i.jsx)(t.a,{href:"https://github.com/ocelot-collab/ocelot/tree/master/unit_tests/ebeam_test",children:(0,i.jsx)(t.code,{children:"unit_tests/ebeam_test/"})}),". Each test is a contribution to the long-term stability of Ocelot."]}),"\n",(0,i.jsx)(t.p,{children:"Happy testing!"})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453:(e,t,s)=>{s.d(t,{R:()=>c,x:()=>a});var n=s(6540);const i={},r=n.createContext(i);function c(e){const t=n.useContext(r);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),n.createElement(r.Provider,{value:t},e.children)}}}]);