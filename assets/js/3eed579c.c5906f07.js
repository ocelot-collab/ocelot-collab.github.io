"use strict";(self.webpackChunkocelot_website=self.webpackChunkocelot_website||[]).push([[652],{3841:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>o,contentTitle:()=>l,default:()=>p,frontMatter:()=>r,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"tutorial/tutorial-beam-dynamics/accelerator_optim","title":"13. Optimization Toy","description":"This notebook was created by Sergey Tomin (sergey.tomin@desy.de) for IPC seminar. October 2020.","source":"@site/docs/tutorial/tutorial-beam-dynamics/accelerator_optim.md","sourceDirName":"tutorial/tutorial-beam-dynamics","slug":"/tutorial/tutorial-beam-dynamics/accelerator_optim","permalink":"/docs/tutorial/tutorial-beam-dynamics/accelerator_optim","draft":false,"unlisted":false,"editUrl":"https://github.com/ocelot-collab/ocelot/docs/tutorial/tutorial-beam-dynamics/accelerator_optim.md","tags":[],"version":"current","sidebarPosition":13,"frontMatter":{"sidebar_position":13,"title":"13. Optimization Toy"},"sidebar":"tutorialSidebar","previous":{"title":"12. Undulator Matching","permalink":"/docs/tutorial/tutorial-beam-dynamics/undulator_matching"},"next":{"title":"14. Useful OCELOT functions","permalink":"/docs/tutorial/tutorial-beam-dynamics/small_useful_features"}}');var s=a(4848),i=a(8453);const r={sidebar_position:13,title:"13. Optimization Toy"},l="Optimization Toy",o={},c=[{value:"Lattice: buch compressor",id:"lattice-buch-compressor",level:3},{value:"Twiss parameters",id:"twiss-parameters",level:3},{value:"Generate the electron beam -  ParticleArray",id:"generate-the-electron-beam----particlearray",level:3},{value:"Track the beam through the lattice",id:"track-the-beam-through-the-lattice",level:3},{value:"What does the screen show?",id:"what-does-the-screen-show",level:3},{value:"What if we have not identical dipoles?",id:"what-if-we-have-not-identical-dipoles",level:3},{value:"Has the beam size on the screen changed?",id:"has-the-beam-size-on-the-screen-changed",level:3},{value:"Let&#39;s minimize the horizontal beam size (dispersion?) on the screen with two last dipoles.",id:"lets-minimize-the-horizontal-beam-size-dispersion-on-the-screen-with-two-last-dipoles",level:3},{value:"What is going on? Let&#39;s have a look to the twiss parameters",id:"what-is-going-on-lets-have-a-look-to-the-twiss-parameters",level:3}];function d(e){const n={a:"a",code:"code",em:"em",h1:"h1",h3:"h3",header:"header",img:"img",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("small",{children:(0,s.jsx)(n.p,{children:(0,s.jsxs)(n.em,{children:["This notebook was created by Sergey Tomin (",(0,s.jsx)(n.a,{href:"mailto:sergey.tomin@desy.de",children:"sergey.tomin@desy.de"}),") for IPC seminar. October 2020."]})})}),"\n",(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"optimization-toy",children:"Optimization Toy"})}),"\n",(0,s.jsx)(n.p,{children:"Here, we consider a simple example of accelerator parameter optimization with OCELOT. The goal is to demonstrate the benefits of using a Python accelerator library like OCELOT."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"from ocelot import *\nfrom ocelot.gui import *\nimport copy\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"    initializing ocelot...\n"})}),"\n",(0,s.jsx)(n.h3,{id:"lattice-buch-compressor",children:"Lattice: buch compressor"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"d = Drift(0.5)\n# Quadrupoles \nqf = Quadrupole(l=0.2, k1=1, k2=2)\nqd = Quadrupole(l=0.2, k1=-1, k2=-2)\n\n# Bends\nangle0 = 14*np.pi/180\nb1 = SBend(l=0.5, angle=angle0, e2=angle0, eid='B1')\nb2 = SBend(l=0.5, angle=-angle0, e1=-angle0, eid='B2')\nb3 = SBend(l=0.5, angle=-angle0, e2=-angle0, eid='B3')\nb4 = SBend(l=0.5, angle=angle0, e1=angle0, eid='B4')\n\nm1 = Marker(eid=\"START\")\nm2 = Marker(eid=\"SCREEN\")\n\nchicane = (b1, d, b2, d, d, b3, d, b4)\n\nfodo = (qf, d, qd, d)\n\ncell = (m1, d, chicane, d, fodo, m2)\n\nlat = MagneticLattice(cell, method={\"global\": SecondTM})\n"})}),"\n",(0,s.jsx)(n.h3,{id:"twiss-parameters",children:"Twiss parameters"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"tws0 = Twiss()\ntws0.beta_x = 10\ntws0.beta_y = 10\ntws0.alpha_x = 0\ntws0.alpha_y = 0\ntws0.E = 100e-3\n\ntws = twiss(lat, tws0)\n\nplot_opt_func(lat, tws)\nplt.show()\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"png",src:a(2033).A+"",width:"639",height:"487"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"R = lattice_transfer_map(lat, energy=100e-3)\nprint(R[4,5])\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"    -0.10311173034412162\n"})}),"\n",(0,s.jsx)(n.h3,{id:"generate-the-electron-beam----particlearray",children:"Generate the electron beam -  ParticleArray"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"p_array_init = generate_parray(sigma_x=1e-3, sigma_px=5e-5, chirp=0.01,\n                               nparticles=20000, charge=1e-09, energy=tws0.E, tws=tws0)\n\nshow_e_beam(p_array_init, figsize=(9,6))\nplt.show()\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"png",src:a(4180).A+"",width:"783",height:"547"})}),"\n",(0,s.jsx)(n.h3,{id:"track-the-beam-through-the-lattice",children:"Track the beam through the lattice"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"p_array = copy.deepcopy(p_array_init)\n\nnavi = Navigator(lat)\n\n#navi.unit_step = 0.1\n#csr = CSR()\n#csr.sigma_min = 4e-6\n#navi.add_physics_proc(csr, m1, m2)\n\ntws_track, _ = track(lat, p_array, navi)\n\nshow_e_beam(p_array, figsize=(9,6))\nplt.show()\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"    z = 6.4 / 6.4. Applied: \n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"png",src:a(5418).A+"",width:"784",height:"547"})}),"\n",(0,s.jsx)(n.h3,{id:"what-does-the-screen-show",children:"What does the screen show?"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'show_density(p_array.x()* 1e3, p_array.y() * 1e3, \n             xlabel="x [mm]", ylabel=\'y [mm]\', title="Screen", limits=[(-4, 4), (-2, 2)])\n\nprint(f"std(x) = {np.std(p_array.x()) * 1e6} um; std(y) = {np.std(p_array.y()) * 1e6} um;")\n'})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"    std(x) = 719.0758746359667 um; std(y) = 399.0834500527979 um;\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"png",src:a(2252).A+"",width:"583",height:"453"})}),"\n",(0,s.jsx)(n.h3,{id:"what-if-we-have-not-identical-dipoles",children:"What if we have not identical dipoles?"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"p_array = copy.deepcopy(p_array_init)\n\nb1.angle = angle0 * (1 + .02)\nb2.angle = -angle0 * (1 - .02)\nb3.angle = -angle0 * (1 - .02)\nb4.angle = angle0 * (1 + .02)\nlat.update_transfer_maps()\n\ntws = twiss(lat, tws0)\nplot_opt_func(lat, tws, legend=False)\nplt.show()\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"png",src:a(375).A+"",width:"639",height:"487"})}),"\n",(0,s.jsx)(n.h3,{id:"has-the-beam-size-on-the-screen-changed",children:"Has the beam size on the screen changed?"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'navi = Navigator(lat)\ntws_track, _ = track(lat, p_array, navi)\nprint(f"std(x) = {np.std(p_array.x()) * 1e6} um; std(y) = {np.std(p_array.y()) * 1e6} um;")\n\nshow_density(p_array.x()* 1e3, p_array.y() * 1e3, \n             xlabel="x [mm]", ylabel=\'y [mm]\', title="Screen", limits=[(-4, 4), (-2, 2)], grid=False)\n'})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"    z = 6.4 / 6.4. Applied: std(x) = 1037.9069892477612 um; std(y) = 398.90408947079084 um;\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"png",src:a(9616).A+"",width:"583",height:"453"})}),"\n",(0,s.jsx)(n.h3,{id:"lets-minimize-the-horizontal-beam-size-dispersion-on-the-screen-with-two-last-dipoles",children:"Let's minimize the horizontal beam size (dispersion?) on the screen with two last dipoles."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'from scipy.optimize import minimize\n\n# Our objective function \ndef get_beam_size(angles):\n    p_array = copy.deepcopy(p_array_init)\n\n    b3.angle = angles[0]\n    b4.angle = angles[1]\n    lat.update_transfer_maps()\n    \n    # NOTE: for simplicity, we do not take into account changes in the drift length between dipoles B3 and B4.\n\n    navi = Navigator(lat)\n    # navi.unit_step = 0.1\n    # csr = CSR()\n    # csr.sigma_min = 4e-6\n    # navi.add_physics_proc(csr, m1, m2)\n    tws_track, _ = track(lat, p_array, navi)\n    return np.std(p_array.x()) \n\nangles = np.copy([b3.angle, b4.angle])\nprint(f"init: angles = {angles}")\n\nres = minimize(fun=get_beam_size, x0=angles)\n\nprint()\nprint(f"res: angles = {res[\'x\']}")\n'})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"    init: angles = [-0.23945917  0.24923302]\n    z = 6.4 / 6.4. Applied: \n    res: angles = [-0.43648764  0.50760325]\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'p_array = copy.deepcopy(p_array_init)\n\nnavi = Navigator(lat)\ntws_track, _ = track(lat, p_array, navi)\n\nshow_density(p_array.x()*1e3, p_array.y()*1e3, xlabel="x [mm]", ylabel=\'y [mm]\', limits=[(-4, 4), (-2, 2)])\nprint(f"std(x) = {np.std(p_array.x()) * 1e6} um; std(y) = {np.std(p_array.y()) * 1e6} um;")\n'})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"    z = 6.4 / 6.4. Applied: std(x) = 162.60623447637025 um; std(y) = 492.3983116819463 um;\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"png",src:a(9075).A+"",width:"583",height:"438"})}),"\n",(0,s.jsx)(n.h3,{id:"what-is-going-on-lets-have-a-look-to-the-twiss-parameters",children:"What is going on? Let's have a look to the twiss parameters"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"tws = twiss(lat, tws0)\nplot_opt_func(lat, tws, legend=False)\nplt.show()\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"png",src:a(9515).A+"",width:"637",height:"487"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"show_e_beam(p_array, figsize=(9,6))\nplt.show()\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"png",src:a(4668).A+"",width:"776",height:"547"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'R = lattice_transfer_map(lat, energy=100e-3)\nprint("R56 = ", R[4,5])\n'})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"    R56 =  -0.24092917476178766\n"})})]})}function p(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},5418:(e,n,a)=>{a.d(n,{A:()=>t});const t=a.p+"assets/images/accelerator_optim_10_1-d7bae45fa10a0b8a2afe73b9770834f4.png"},2252:(e,n,a)=>{a.d(n,{A:()=>t});const t=a.p+"assets/images/accelerator_optim_12_1-452483eb76142fcd5ccae8c7c70a261e.png"},375:(e,n,a)=>{a.d(n,{A:()=>t});const t=a.p+"assets/images/accelerator_optim_14_0-3209ff177f228a093f7f8fe888b4b8f3.png"},9616:(e,n,a)=>{a.d(n,{A:()=>t});const t=a.p+"assets/images/accelerator_optim_16_1-a6949c64f696d0c74e6685161c9fb281.png"},9075:(e,n,a)=>{a.d(n,{A:()=>t});const t=a.p+"assets/images/accelerator_optim_19_1-d6b6ed17584eadf5b3c1a520880d91ec.png"},9515:(e,n,a)=>{a.d(n,{A:()=>t});const t=a.p+"assets/images/accelerator_optim_21_0-567d1013681567fcbc12ab2873bdbe8a.png"},4668:(e,n,a)=>{a.d(n,{A:()=>t});const t=a.p+"assets/images/accelerator_optim_22_0-a2663adc257568d9aa286b7890b174bf.png"},2033:(e,n,a)=>{a.d(n,{A:()=>t});const t=a.p+"assets/images/accelerator_optim_5_0-9b2a7a6d8b7a5efcca649bbbe2fe28be.png"},4180:(e,n,a)=>{a.d(n,{A:()=>t});const t=a.p+"assets/images/accelerator_optim_8_0-734b834709ae147249efc2ea16123822.png"},8453:(e,n,a)=>{a.d(n,{R:()=>r,x:()=>l});var t=a(6540);const s={},i=t.createContext(s);function r(e){const n=t.useContext(i);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);