<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-docu/physics-processes/energy-profile" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Lattice Energy Profile | OCELOT</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://ocelot-collab.com/docs/docu/physics-processes/energy-profile"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Lattice Energy Profile | OCELOT"><meta data-rh="true" name="description" content="LatticeEnergyProfile class for managing reference energy in simulations."><meta data-rh="true" property="og:description" content="LatticeEnergyProfile class for managing reference energy in simulations."><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ocelot-collab.com/docs/docu/physics-processes/energy-profile"><link data-rh="true" rel="alternate" href="https://ocelot-collab.com/docs/docu/physics-processes/energy-profile" hreflang="en"><link data-rh="true" rel="alternate" href="https://ocelot-collab.com/docs/docu/physics-processes/energy-profile" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://A7SK3UKMX4-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="OCELOT" href="/opensearch.xml">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.0b89c045.css">
<script src="/assets/js/runtime~main.b2a80e34.js" defer="defer"></script>
<script src="/assets/js/main.54518d56.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/img/logo.png"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.png" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">OCELOT</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/docu/intro">Documentation</a><a class="navbar__item navbar__link" href="/docs/tutorial/intro">Tutorials</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/ocelot-collab/ocelot" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/docu/intro">Introduction</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/ocelot-basics">OCELOT Basics</a><button aria-label="Expand sidebar category &#x27;OCELOT Basics&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/elements">Elements</a><button aria-label="Expand sidebar category &#x27;Elements&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/transfer-maps">Transfer Maps</a><button aria-label="Expand sidebar category &#x27;Transfer Maps&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/category/physics-processes">Physics Processes</a><button aria-label="Collapse sidebar category &#x27;Physics Processes&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docu/physics-processes/phys-proc">PhysProc Parent Class</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docu/physics-processes/sc">Space Charge 3D</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docu/physics-processes/lsc">Longitudinal Space Charge</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docu/physics-processes/wake">Wakefields</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docu/physics-processes/csr">CSR</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docu/physics-processes/ibs">IBS</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docu/physics-processes/slotted-foil">Slotted Foil</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docu/physics-processes/laser-modulator">LaserModulator</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docu/physics-processes/sr-effect">Spontaneous Radiation Effect</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docu/physics-processes/apertures">Aperture Classes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docu/physics-processes/beamtransform">BeamTransform</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docu/physics-processes/beam-analysis">Beam Analysis</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docu/physics-processes/chicane">Chicane</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/docu/physics-processes/energy-profile">Lattice Energy Profile</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/docu/physics-processes/savebeam">SaveBeam &amp; CopyBeam</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/useful-functions">Useful Functions</a><button aria-label="Expand sidebar category &#x27;Useful Functions&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/category/how-to">How To</a><button aria-label="Expand sidebar category &#x27;How To&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/category/physics-processes"><span itemprop="name">Physics Processes</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Lattice Energy Profile</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><small><p><em>Sergey Tomin (<a href="mailto:sergey.tomin@desy.de" target="_blank" rel="noopener noreferrer">sergey.tomin@desy.de</a>). June 2025.</em></p></small>
<header><h1><a href="https://github.com/ocelot-collab/ocelot/blob/master/ocelot/cpbd/physics_proc.py#L624" target="_blank" rel="noopener noreferrer">Lattice Energy Profile</a></h1></header>
<p>The <code>LatticeEnergyProfile</code> class is a physics process used in Ocelot simulations to adjust the reference energy (<code>Eref</code>) of a <a href="/docs/docu/OCELOT fundamentals/particle-array"><code>ParticleArray</code></a>.
It then recalculates the canonical momentum <code>p = (E_particle - Eref) / p0c</code> for all particles relative to this new reference energy.</p>
<p>This is particularly useful in scenarios where the actual energy of the beam deviates from the design energy for which
a section of the accelerator lattice (e.g., magnets) is configured. By using <code>LatticeEnergyProfile</code>, one can simulate
the effect of particles with a certain energy traversing magnetic elements that are effectively &quot;set&quot; for a different reference energy.</p>
<p><strong>Key Points:</strong></p>
<ul>
<li>It changes the <code>ParticleArray.E</code> attribute (the reference energy).</li>
<li>It recalculates the 6th phase space coordinate (<code>p</code>) of each particle to be consistent with the new reference energy.</li>
<li><strong>Crucially, the actual physical energy of each particle (<code>E_particle</code>) remains unchanged by this process.</strong></li>
<li>Only its representation relative to <code>Eref</code> is modified.</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="latticeenergyprofile-class">LatticeEnergyProfile Class<a href="#latticeenergyprofile-class" class="hash-link" aria-label="Direct link to LatticeEnergyProfile Class" title="Direct link to LatticeEnergyProfile Class">​</a></h2>
<p>Modifies a <a href="/docs/docu/OCELOT fundamentals/particle-array"><code>ParticleArray</code></a>&#x27;s reference energy (<code>Eref</code>) and updates the canonical momentum of particles accordingly.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-it-works">How it Works<a href="#how-it-works" class="hash-link" aria-label="Direct link to How it Works" title="Direct link to How it Works">​</a></h3>
<p>The canonical momentum <code>p</code> for a particle is defined as:
<code>p = (E_particle - Eref) / p0c</code>
where:</p>
<ul>
<li><code>E_particle</code> is the actual energy of the particle.</li>
<li><code>Eref</code> is the reference energy of the <a href="/docs/docu/OCELOT fundamentals/particle-array"><code>ParticleArray</code></a>.</li>
<li><code>p0c = sqrt(Eref^2 - m_e_GeV^2)</code> is the reference momentum corresponding to <code>Eref</code>.</li>
</ul>
<p>When <code>LatticeEnergyProfile</code> is applied with a new <code>Eref_new</code>:</p>
<ol>
<li>The old particle energy <code>E_particle</code> is preserved:
<code>E_particle = p_old * p0c_old + Eref_old</code></li>
<li>The new canonical momentum <code>p_new</code> is calculated using <code>Eref_new</code>:
<code>p_new = (E_particle - Eref_new) / p0c_new</code>
Substituting <code>E_particle</code>:
<code>p_new = ( (p_old * p0c_old + Eref_old) - Eref_new ) / p0c_new</code></li>
<li>The <code>ParticleArray</code>&#x27;s reference energy is updated: <code>p_array.E = Eref_new</code>.</li>
<li>The particles&#x27; canonical momenta are updated: <code>p_array.p()[:] = p_new</code>.</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="parameters">Parameters:<a href="#parameters" class="hash-link" aria-label="Direct link to Parameters:" title="Direct link to Parameters:">​</a></h3>
<ul>
<li><strong>Eref</strong> (<code>float</code>): The new reference energy in GeV to which the <a href="/docs/docu/OCELOT fundamentals/particle-array"><code>ParticleArray</code></a>&#x27;s reference will be set.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="methods">Methods:<a href="#methods" class="hash-link" aria-label="Direct link to Methods:" title="Direct link to Methods:">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="__init__self-eref"><code>__init__(self, Eref)</code><a href="#__init__self-eref" class="hash-link" aria-label="Direct link to __init__self-eref" title="Direct link to __init__self-eref">​</a></h4>
<p>Constructor for the <code>LatticeEnergyProfile</code> class.</p>
<ul>
<li><code>Eref</code> (<code>float</code>): The target reference energy in GeV.
Initializes the process and stores <code>Eref</code>. It also calls the parent class (<a href="/docs/docu/physics-processes/phys-proc"><code>PhysProc</code></a>) initializer.</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="applyself-p_array-dz0"><code>apply(self, p_array, dz=0)</code><a href="#applyself-p_array-dz0" class="hash-link" aria-label="Direct link to applyself-p_array-dz0" title="Direct link to applyself-p_array-dz0">​</a></h4>
<p>Applies the reference energy shift to the given particle array (<code>p_array</code>).</p>
<ul>
<li><code>p_array</code> (<a href="/docs/docu/OCELOT fundamentals/particle-array"><code>ParticleArray</code></a>): The particle array to be modified.</li>
<li><code>dz</code> (<code>float</code>, optional): Path length, typically unused by this process.</li>
</ul>
<p>This method performs the recalculation of canonical momenta as described in &quot;How it Works&quot;.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="example-usage">Example Usage<a href="#example-usage" class="hash-link" aria-label="Direct link to Example Usage" title="Direct link to Example Usage">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="basic-application">Basic Application<a href="#basic-application" class="hash-link" aria-label="Direct link to Basic Application" title="Direct link to Basic Application">​</a></h3>
<p>This example shows how to change the reference energy of a <a href="/docs/docu/OCELOT fundamentals/particle-array"><code>ParticleArray</code></a> and demonstrates that the actual mean energy of the particles is conserved.</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> ocelot</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cpbd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">beam </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> ParticleArray</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> generate_parray</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> ocelot</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cpbd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">physics_proc </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> LatticeEnergyProfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> ocelot</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">common</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">globals</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> m_e_GeV</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> numpy </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> np</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Initial reference energy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E_initial_ref </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.5</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># GeV</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Create a particle array with some energy spread</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># For this example, let&#x27;s use generate_parray to create a realistic beam</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Note: generate_parray sets the ParticleArray.E to the specified energy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">parray </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> generate_parray</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">energy</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">E_initial_ref</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sigma_p</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.001</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nparticles</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Initial ParticleArray E (reference): </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">parray</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">E</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.4f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> GeV&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Calculate initial mean physical energy of particles</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p0c_initial </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sqrt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">parray</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">E</span><span class="token operator" style="color:#393A34">**</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> m_e_GeV</span><span class="token operator" style="color:#393A34">**</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mean_E_physical_initial </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">parray</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> p0c_initial </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> parray</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">E</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Initial mean physical particle energy: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">mean_E_physical_initial</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.4f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> GeV&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Initial mean p coordinate: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">np</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">mean</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">parray</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">p</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.4e</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Define the new reference energy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E_new_ref </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.505</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># GeV</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Create LatticeEnergyProfile instance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lep </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> LatticeEnergyProfile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Eref</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">E_new_ref</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Apply the process</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lep</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">apply</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">parray</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Updated ParticleArray E (new reference): </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">parray</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">E</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.4f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> GeV&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Calculate new mean physical energy of particles</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p0c_new </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sqrt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">parray</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">E</span><span class="token operator" style="color:#393A34">**</span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> m_e_GeV</span><span class="token operator" style="color:#393A34">**</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mean_E_physical_new </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">mean</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">parray</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">p</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> p0c_new </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> parray</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">E</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Updated mean physical particle energy: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">mean_E_physical_new</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.4f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> GeV&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Updated mean p coordinate: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">np</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">mean</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation">parray</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">p</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">(</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">)</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.4e</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Verify that the physical energy is conserved</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">assert</span><span class="token plain"> np</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isclose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mean_E_physical_initial</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mean_E_physical_new</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&quot;Mean physical energy should be conserved!&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Assertion passed: Mean physical energy is conserved.&quot;</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Initial ParticleArray E (reference): 0.5000 GeV
Initial mean physical particle energy: 0.5001 GeV
Initial mean p coordinate: 1.3081e-04</p>
<p>Updated ParticleArray E (new reference): 0.5050 GeV
Updated mean physical particle energy: 0.5001 GeV
Updated mean p coordinate: -9.7715e-03</p>
<p>Assertion passed: Mean physical energy is conserved.</p>
<p>This shows that while <code>parray.E</code> (the reference energy) and <code>parray.p()</code> (canonical momentum) change,
the actual average energy of the particles remains the same.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="simulating-fixed-magnet-settings-with-beam-energy-jitter">Simulating Fixed Magnet Settings with Beam Energy Jitter<a href="#simulating-fixed-magnet-settings-with-beam-energy-jitter" class="hash-link" aria-label="Direct link to Simulating Fixed Magnet Settings with Beam Energy Jitter" title="Direct link to Simulating Fixed Magnet Settings with Beam Energy Jitter">​</a></h3>
<p>A common use case is to simulate how a beam with an off-nominal energy behaves in a lattice designed for a nominal energy.
Magnets (quadrupoles, bends) in Ocelot typically use the <code>ParticleArray.E</code> attribute as their reference energy.
If the beam&#x27;s actual energy drifts but <code>ParticleArray.E</code> is also updated to this drifted energy, the magnets would &quot;implicitly retune&quot;
themselves, which is not realistic.</p>
<p>The <code>LatticeEnergyProfile</code> allows you to set <code>ParticleArray.E</code> to the <em>design</em> energy of the magnets right before tracking
through them, even if the particles themselves have a different average physical energy (e.g., due to RF phase/voltage errors).</p>
<p>Consider a simplified scenario:</p>
<ol>
<li>Beam is accelerated in a cavity. Due to jitter, its final energy <code>E_actual</code> is slightly different from the design energy <code>E_design</code>.</li>
<li>The beam then enters a FODO cell designed for <code>E_design</code>.</li>
</ol>
<p><strong>Important Considerations:</strong></p>
<ul>
<li>
<p><strong>Observing Energy-Dependent Effects:</strong>
In quadrupoles, first-order transverse dynamics are generally independent of particle energy. Therefore, to observe the differences caused by an energy mismatch (where <code>E_actual</code> deviates from <code>E_design</code>) and thus see the impact of using <code>LatticeEnergyProfile</code>, you typically need to enable second-order calculations. Without this, the chromatic effects that <code>LatticeEnergyProfile</code> helps to model might not be apparent in the transverse dynamics from quadrupoles.</p>
</li>
<li>
<p><strong>Magnitude of Energy Difference:</strong>
The difference between the actual beam energy (<code>E_actual</code>) and the design reference energy (<code>E_design</code> set by <code>LatticeEnergyProfile</code>) should not be excessively large. Ocelot&#x27;s transfer matrices for elements like quadrupoles, dipoles etc. are often expanded to a certain order (e.g., up to second order). If the energy deviation is too significant, higher-order effects not included in these models might become important, potentially reducing the accuracy of the simulation. While a precise limit isn&#x27;t strictly defined (<em>maybe someone study this?</em>), keeping the energy difference within a couple of percent is a common guideline for obtaining reasonably accurate results with such models.</p>
</li>
</ul>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> ocelot </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> MagneticLattice</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Drift</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Quadrupole</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Cavity</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Navigator</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Marker</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SecondTM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> ocelot</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cpbd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">beam </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Twiss</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> generate_parray</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> ocelot</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cpbd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">track </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> track</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> ocelot</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">cpbd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">physics_proc </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> LatticeEnergyProfile</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> matplotlib</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">pyplot </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> plt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># (Assuming necessary plotting imports if you want to visualize)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># --- Beam and Lattice Setup ---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E_design_gun </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.005</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># GeV</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tws_initial </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Twiss</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">beta_x</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">7</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> beta_y</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> emit_xn</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.5e-6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> emit_yn</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> E</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">E_design_gun</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Simplified Twiss</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># ... (set other tws_initial parameters if needed for a full run)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">initial_parray </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> generate_parray</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sigma_tau</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.001</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sigma_p</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1e-4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> charge</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">100e-12</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tws</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">tws_initial</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E_design_linac_exit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.130</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># 130 MeV</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">E_actual_linac_exit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.125</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># Actual energy due to jitter (e.g. 125 MeV)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Simulated cavity that gives slightly less energy</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cav </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Cavity</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">l</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> v</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">E_actual_linac_exit </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> E_design_gun</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> freq</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">1.3e9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> phi</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># simplified voltage</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># cav.v is V_eff = E_gain / q_e</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Marker after cavity, before FODO</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">m_cav_exit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Marker</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;CAV_EXIT&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># FODO designed for E_design_linac_exit</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">qf </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Quadrupole</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">l</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> k1</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> eid</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;QF&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic"># k1 depends on E_design</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">qd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Quadrupole</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">l</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> k1</span><span class="token operator" style="color:#393A34">=</span><span class="token operator" style="color:#393A34">-</span><span class="token number" style="color:#36acaa">2.0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> eid</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;QD&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Drift</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">l</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.5</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">fodo_cell </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">m_cav_exit</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> qf</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> qd</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> dr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Full lattice: gun energy section -&gt; cavity -&gt; FODO</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lat </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MagneticLattice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cav</span><span class="token punctuation" style="color:#393A34">,</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> fodo_cell</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> method</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;global&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">SecondTM</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># --- Case 1: No LatticeEnergyProfile (Implicit magnet retuning) ---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Set the parray&#x27;s E to the actual energy. Magnets will scale based on this.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p_array_case1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> initial_parray</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">copy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># track through cavity, p_array_case1.E will be updated by cavity</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># For simplicity in this example snippet, we assume p_array_case1 has E_actual_linac_exit AFTER cavity.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># In a real track, the cavity itself updates parray.E if p_array.E is near particle energy.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># If E_actual is very different, this gets complex without LEP even for cavity.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Let&#x27;s assume after the cavity, the p_array.E reflects E_actual_linac_exit</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Beam energy before tracking cavity (Case 1): </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">p_array_case1</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">E</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.4f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> GeV&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Simulate cavity effect roughly on reference energy for simplicity of this snippet.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># In a full track(), cavity updates .E</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># If you track part by part, this needs manual care or specific cavity flags.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># Here we&#x27;ll just track through lattice assuming cavity updated parray.E correctly</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># and then for FODO, if p_array_case1.E is E_actual_linac_exit, magnets scale.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># We will use the fact that tracking a cavity updates p_array.E</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">twiss_track_case1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p_array_tracked_case1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> track</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lat</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p_array_case1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Navigator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Beam reference energy after FODO (Case 1): </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">p_array_tracked_case1</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">E</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.4f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> GeV&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># The FODO quadrupoles (qf, qd) effectively &quot;saw&quot; a beam with E_actual_linac_exit</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># and their k1 values were interpreted against this energy.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># --- Case 2: With LatticeEnergyProfile (Magnets see E_design) ---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">p_array_case2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> initial_parray</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">copy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nav </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Navigator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lat</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># After the cavity (m_cav_exit), force the reference energy to E_design_linac_exit</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># so subsequent magnets (FODO) act as if beam has E_design_linac_exit</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">lep_fodo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> LatticeEnergyProfile</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Eref</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">E_design_linac_exit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nav</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add_physics_proc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lep_fodo</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> m_cav_exit</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> m_cav_exit</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;\nBeam energy before tracking cavity (Case 2): </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">p_array_case2</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">E</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.4f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> GeV&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">twiss_track_case2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p_array_tracked_case2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> track</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">lat</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> p_array_case2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nav</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Beam reference energy after FODO (Case 2): </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">p_array_tracked_case2</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">E</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">:</span><span class="token string-interpolation interpolation format-spec">.4f</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> GeV&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># The cavity accelerates the beam, and its real energy will be ~E_actual_linac_exit.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># The `lep_fodo` process then changes `p_array_case2.E` to `E_design_linac_exit`.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># So, qf and qd act on particles as if the reference design energy is E_design_linac_exit,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># even though the particles&#x27; physical energies are centered around E_actual_linac_exit.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># The final parray.E from track() will be E_design_linac_exit due to the last LEP application.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># If you print p_array_tracked_case2.get_mean_energy(), it will be around E_actual_linac_exit.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># To verify (conceptual):</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Case 1 (FODO entrance): Ref E = </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">E_actual_linac_exit</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">, Actual mean E ~ </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">E_actual_linac_exit</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;Case 2 (FODO entrance): Ref E = </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">E_design_linac_exit</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">, Actual mean E ~ </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">E_actual_linac_exit</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># plot Twiss paramteters for two casses </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">s </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">tw</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">s </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> tw </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> twiss_track_case1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bx1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">tw</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">beta_x </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> tw </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> twiss_track_case1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">by1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">tw</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">beta_y </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> tw </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> twiss_track_case1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bx2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">tw</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">beta_x </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> tw </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> twiss_track_case2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">by2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">tw</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">beta_y </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> tw </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> twiss_track_case2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plot</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bx1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> label</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">r&quot;$\beta_x$ CASE 1&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plot</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bx2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> label</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">r&quot;$\beta_x$ CASE 2&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plot</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> by1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> label</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">r&quot;$\beta_y$ CASE 1&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">plot</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> by2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> label</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">r&quot;$\beta_y$ CASE 2&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">legend</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">xlabel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;s [m]&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ylabel</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">r&quot;$\beta_{x,y}$ [m]&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">plt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">show</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">INFO</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">0mTwiss parameters have priority</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> sigma_</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> px</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> py</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> will be redefine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Beam energy before tracking cavity </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Case </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0050</span><span class="token plain"> GeV</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    z </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2.2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2.2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> Applied</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Beam reference energy after FODO </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Case </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.1250</span><span class="token plain"> GeV</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Beam energy before tracking cavity </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Case </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0050</span><span class="token plain"> GeV</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    z </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2.2</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2.2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> Applied</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Beam reference energy after FODO </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">Case </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.1300</span><span class="token plain"> GeV</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Case </span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">FODO entrance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ref E </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.125</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Actual mean E </span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.125</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Case </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">FODO entrance</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> Ref E </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.13</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Actual mean E </span><span class="token operator" style="color:#393A34">~</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.125</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" alt="png" src="/assets/images/lattice_energy_profile_3_2-6a0edb61eb4fc889d93f02f62431c619.png" width="568" height="432" class="img_ev3q"></p>
<p>In Case 2, the <code>LatticeEnergyProfile</code> ensures that the FODO cell quadrupoles apply kicks calculated based on <code>E_design_linac_exit</code>,
correctly simulating their fixed settings, while the particles traverse them with an average physical energy of <code>E_actual_linac_exit</code>.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a href="#summary" class="hash-link" aria-label="Direct link to Summary" title="Direct link to Summary">​</a></h2>
<p>The <code>LatticeEnergyProfile</code> class is an essential tool for accurately simulating beam dynamics in accelerators
where the beam&#x27;s energy may vary from the design energy of specific lattice sections.
It allows the user to define fixed reference energies for lattice segments,
ensuring that magnetic elements behave as per their design specifications irrespective of incoming beam energy fluctuations.
This is crucial for studying effects like RF jitter, energy ramps, or modeling sections with different design energies.</p>
<p>For a detailed tutorial demonstrating the simulation of RF jitter using <code>LatticeEnergyProfile</code>, please see:
<a href="/docs/tutorial/tutorial-beam-dynamics/small_useful_features">Energy Jitter Simulation Tutorial</a>.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/ocelot-collab/ocelot-collab.github.io/tree/main/docs/docu/physics-processes/energy-profile.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/docu/physics-processes/chicane"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Chicane</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/docu/physics-processes/savebeam"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">SaveBeam &amp; CopyBeam</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#latticeenergyprofile-class" class="table-of-contents__link toc-highlight">LatticeEnergyProfile Class</a><ul><li><a href="#how-it-works" class="table-of-contents__link toc-highlight">How it Works</a></li><li><a href="#parameters" class="table-of-contents__link toc-highlight">Parameters:</a></li><li><a href="#methods" class="table-of-contents__link toc-highlight">Methods:</a></li></ul></li><li><a href="#example-usage" class="table-of-contents__link toc-highlight">Example Usage</a><ul><li><a href="#basic-application" class="table-of-contents__link toc-highlight">Basic Application</a></li><li><a href="#simulating-fixed-magnet-settings-with-beam-energy-jitter" class="table-of-contents__link toc-highlight">Simulating Fixed Magnet Settings with Beam Energy Jitter</a></li></ul></li><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/tutorial/intro">Tutorial</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/docu/intro">Documentation</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/ocelot-collab/ocelot" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 OCELOT, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>